<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Table Tennis Scoreboard</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:green; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
.overlay { background: rgba(255,255,255,0.95); border-radius:12px; padding:15px; margin:10px; width:900px; text-align:center; }
.tabs { display:flex; margin-bottom:10px; }
.tab { padding:10px 20px; border:1px solid #ccc; cursor:pointer; margin-right:5px; border-radius:8px 8px 0 0; background:#f0f0f0; }
.tab.active { background:#fff; border-bottom:none; font-weight:bold; }
.tab-content { border:1px solid #ccc; padding:20px; border-radius:0 8px 8px 8px; display:none; }
.tab-content.active { display:block; }
.players { display:flex; justify-content:space-around; }
.player { text-align:center; width:40%; position:relative; }
.player-score { display:flex; align-items:center; justify-content:center; }
.score { font-size:7em; margin:10px; }
.serve { font-size:3em; margin-left:10px; } 
button { font-size:1em; margin:5px; padding:8px 16px; }
.cards { margin-top:10px; display:flex; justify-content:center; }
.cards span { display:inline-block; width:25px; height:35px; margin:2px; border-radius:4px; }
.cards .timeout { background:#ffffff; border:1px solid #ccc; }
.cards .yellow { background:#FFD700; }
.cards .red { background:#FF0000; }
.status { font-size:1.5em; font-weight:bold; color:orange; margin-top:10px; }
.point-btn { font-size:1.5em; padding:12px 24px; font-weight:bold; background-color:#ffeb3b; border-radius:8px; }
#timerDisplay { font-size:3em; font-weight:bold; color:red; text-align:center; margin:10px 0; }
#timerControls { text-align:center; display:none; margin-bottom:10px; }
#timerControls button { margin:5px; }
#clearTimerBtn { display:none; font-size:1em; padding:8px 16px; background:#f44336; color:white; border:none; border-radius:6px; }
#startScreen, #positionScreen { display:flex; flex-direction:column; justify-content:center; align-items:center; min-height:80vh; }
#startScreen button, #positionScreen button { font-size:2em; padding:20px 40px; margin:10px; }

.player-score {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.player.left .games {
  position: absolute;
  left: 0;       /* å·¦ç«¯ã«å›ºå®š */
}

.player.right .games {
  position: absolute;
  right: 0;      /* å³ç«¯ã«å›ºå®š */
}

.games {
  font-size: 2.7em;
  color: blue;
  font-weight: bold;
  flex-shrink: 0;
}
#winner {
  font-size: 2em;
  color: red;
  font-weight: bold;
  text-align: center;
  margin-top: 20px;
}

.pointStatus {
    font-size: 1.3em;    
    font-weight: normal;
    color: red;
    line-height: 0.4;
    height: 1em;            /* â† é«˜ã•ã‚’å›ºå®šã™ã‚‹ */
    display: block;         /* å¸¸ã«åŒã˜é«˜ã•ã‚’å ã‚ã‚‹ */
    text-align: center;
}

#history {
  max-height: 40vh; /* ç”»é¢ã®40%ã¾ã§ã«åˆ¶é™ */
  overflow-y: auto; /* ã¯ã¿å‡ºã—ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
}

#timerDisplay {
  color: blue;           /* â†ã“ã“ã‚’èµ¤ã‹ã‚‰é’ã« */
  font-weight: bold;
  font-size: 2em;
}

.card-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.card {
  width: 60px;
  height: 80px;
  border: 2px solid #333;
  border-radius: 8px;
  font-size: 1.5em;
  font-weight: bold;
  cursor: pointer;
  color: #000;
  transition: transform 0.1s, box-shadow 0.2s;
}

.card:hover {
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
}

.card.yellow {
  background-color: #ffeb3b; /* æ˜ã‚‹ã„é»„è‰² */
}

.card.red {
  background-color: #f44336; /* é®®ã‚„ã‹ãªèµ¤ */
  color: #fff;
}

.card.remove {
  opacity: 0.7;
  font-size: 1.3em;
}

.card.remove:hover {
  opacity: 1;
}


/* ã‚µãƒ¼ãƒ–ãƒ¬ãƒƒãƒˆä¸­å¤®ä¸‹éƒ¨é…ç½® */
#serveLetContainer { margin-top:20px; display:flex; justify-content:center; align-items:center; gap:20px; }
#serveLetContainer button {
    font-size: 1.2em;
    padding: 20px;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #ffeb3b;
    border: none;
    cursor: pointer;
}
#serveLetContainer button:hover { background-color: #ffd700; }
#playingTimerDisplay { font-size:1em; color:blue; min-width:80px; text-align:left; margin-left:10px; }
</style>
</head>
<body>

<div class="overlay" id="startScreen">
  <h1>SELECT FIRST SERVER</h1>
  <button onclick="selectServer('A')">PLAYER A</button>
  <button onclick="selectServer('B')">PLAYER B</button>
</div>

<div class="overlay" id="positionScreen" style="display:none;">
  <h1>SELECT PLAYER ON LEFT</h1>
  <button onclick="selectPosition('A')">PLAYER A LEFT</button>
  <button onclick="selectPosition('B')">PLAYER B LEFT</button>
  <button onclick="backToServerSelection()">BACK</button>
</div>

<div class="overlay" id="mainScreen" style="display:none;">

<div id="winner"></div>

<div id="timerDisplay"></div>
<div id="timerControls">
  <button onclick="startTimer()">START TIMER</button>
  <button onclick="stopTimer()">STOP TIMER</button>
  <button onclick="resetTimer()">RESET TIMER</button>
</div>
<button id="clearTimerBtn" onclick="forceEndTimer()">CLEAR TIMER</button>

<div style="margin:10px 0;">
  <button onclick="prepareTimer('WARM UP')">SET WARM UP (120s)</button>
  <button onclick="prepareTimer('WATER BREAK')">SET WATER BREAK (60s)</button>
</div>

<div>
  Match Type: 
  <select id="matchType" onchange="setMatchType()">
  <option value="2">2 Games (Best of 3)</option>
  <option value="3" selected>3 Games (Best of 5)</option>
  <option value="4">4 Games (Best of 7)</option>
</select>
  &nbsp;&nbsp; First Server:
  <span id="firstServerDisplay"></span>
  <button onclick="setPosition()" style="font-size:0.9em;">SET POSITION</button>
  <button onclick="correctServer()" style="font-size:0.9em;">CHANGE FIRST SERVER</button>
</div>



<div class="tabs">
  <div class="tab active" onclick="showTab('scoreTab', event)">Score & Timeout</div>
  <div class="tab" onclick="showTab('cardsTab', event)">Cards</div>
  <div class="tab" onclick="showTab('expediteTab', event)">Expedite</div>
</div>

<div id="expediteTab" class="tab-content">
  <h3>EXPEDITE RULE</h3>
  <p>Manage the expedite system for this match.</p>

  <button onclick="activateExpediteRule()" 
          id="startExpediteBtn"
          style="font-size:1.3em; padding:15px 25px; background-color:#ff9800; color:white; border:none; border-radius:10px; cursor:pointer; margin:10px;">
    START EXPEDITE RULE
  </button>

  <button onclick="deactivateExpediteRule()" 
          id="stopExpediteBtn"
          style="font-size:1.3em; padding:15px 25px; background-color:#555; color:white; border:none; border-radius:10px; cursor:pointer; margin:10px;">
    STOP EXPEDITE RULE
  </button>
</div>


<div id="scoreTab" class="tab-content active">
  <div class="players" id="court">
    <div class="player" id="playerA">
     

 <h2>PLAYER A</h2>
     <div class="player-score">
  <span class="games" id="gamesA">0</span>
  <span id="scoreA" class="score">0</span>
  <span id="serveA" class="serve"></span>
</div>
<div class="pointStatus" id="pointStatusA">&nbsp;</div>
<div><span id="pointAStatus" class="pointStatus"></span></div>


      <button class="point-btn" onclick="addPoint('A')">+1 POINT</button>
      <button onclick="removePoint('A')">-1 POINT</button><br>
      <button onclick="timeout('A')">TIMEOUT</button>
      <button onclick="removeCard('A','timeout')">UNDO TIMEOUT</button>
      <div class="cards" id="cardsA"></div>
    </div>
    <div class="player" id="playerB">
     

 <h2>PLAYER B</h2>
     <div class="player-score">
  <span id="scoreB" class="score">0</span>
  <span class="games" id="gamesB">0</span>
  <span id="serveB" class="serve"></span>
</div>
<div class="pointStatus" id="pointStatusB">&nbsp;</div>
<div><span id="pointBStatus" class="pointStatus"></span></div>


 <button class="point-btn" onclick="addPoint('B')">+1 POINT</button>
      <button onclick="removePoint('B')">-1 POINT</button><br>
      <button onclick="timeout('B')">TIMEOUT</button>
      <button onclick="removeCard('B','timeout')">UNDO TIMEOUT</button>
      <div class="cards" id="cardsB"></div>
    </div>
  </div>
 
  <button onclick="nextGame()">NEXT GAME</button>
  <button onclick="resetMatch()">RESET MATCH</button>
  <button onclick="undo()">UNDO LAST ACTION</button>

  <div id="serveLetContainer">
    <button onclick="servePoint()">SERVE</button>
    <button onclick="letPoint()">LET</button>
    <span id="playingTimerDisplay">0.0s</span>
  </div>
</div>

<div id="cardsTab" class="tab-content">
  <h3>CARD MANAGEMENT</h3>
  <div class="players">
    <div class="player">
      <h2>PLAYER A</h2>
      <div class="card-buttons">
        <button class="card yellow" onclick="card('A','yellow')">+</button>
        <button class="card yellow remove" onclick="removeCard('A','yellow')">âˆ’</button>
        <button class="card red" onclick="card('A','red')">+</button>
        <button class="card red remove" onclick="removeCard('A','red')">âˆ’</button>
      </div>
    </div>
    <div class="player">
      <h2>PLAYER B</h2>
      <div class="card-buttons">
        <button class="card yellow" onclick="card('B','yellow')">+</button>
        <button class="card yellow remove" onclick="removeCard('B','yellow')">âˆ’</button>
        <button class="card red" onclick="card('B','red')">+</button>
        <button class="card red remove" onclick="removeCard('B','red')">âˆ’</button>
      </div>
    </div>
  </div>
</div>



  </div>
</div>




<div id="historyTab" class="tab-content">
  <h3>GAME HISTORY</h3>
  <ul id="historyList"></ul>
</div>

<script>
// ----------------------------
// å¤‰æ•°
let scoreA=0,scoreB=0,gamesA=0,gamesB=0,firstServer='A',serveTurn='A',GAMES_TO_WIN=3,gameNumber=1;
let cardCount={A:{yellow:0,red:0,timeout:0},B:{yellow:0,red:0,timeout:0}};
let historyStack=[];
let timerInterval=null,timerSeconds=0,timerLabel="";
let leftPlayer='A', rightPlayer='B';
let playingSeconds=0, playingTimerInterval=null;

// ----------------------------
// ã‚µãƒ¼ãƒ–/å·¦å³é¸æŠ
function selectServer(player){ firstServer=player; document.getElementById('startScreen').style.display='none'; document.getElementById('positionScreen').style.display='flex'; }
function backToServerSelection(){ document.getElementById('positionScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }
function selectPosition(playerOnLeft){ leftPlayer=playerOnLeft; rightPlayer=(playerOnLeft==='A')?'B':'A'; document.getElementById('positionScreen').style.display='none'; document.getElementById('mainScreen').style.display='block'; updatePlayerPositions(); document.getElementById('firstServerDisplay').innerText=firstServer; updateServer(); }
function setPosition(){ document.getElementById('positionScreen').style.display='flex'; document.getElementById('mainScreen').style.display='none'; }
function correctServer(){ document.getElementById('mainScreen').style.display='none'; document.getElementById('positionScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }
function updatePlayerPositions(){ const court=document.getElementById('court'); court.appendChild(document.getElementById('player'+leftPlayer)); court.appendChild(document.getElementById('player'+rightPlayer)); }

// ----------------------------
// ã‚¿ãƒ–åˆ‡æ›¿
function showTab(tabId, event){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); event.target.classList.add('active'); document.getElementById(tabId).classList.add('active'); }

// ----------------------------
// ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚²ãƒ¼ãƒ ç®¡ç†
function saveState(){ historyStack.push({scoreA,scoreB,gamesA,gamesB,cardCount:JSON.parse(JSON.stringify(cardCount)),playingSeconds}); }
function undo(){ if(historyStack.length>0){ let last=historyStack.pop(); scoreA=last.scoreA; scoreB=last.scoreB; gamesA=last.gamesA; gamesB=last.gamesB; cardCount=last.cardCount; playingSeconds=last.playingSeconds; updateScores(); updateCards('A'); updateCards('B'); document.getElementById('gamesA').innerText=gamesA; document.getElementById('gamesB').innerText=gamesB; updatePointStatus(); updatePlayingTimerDisplay(); } }
function addPoint(player){
    saveState();
    if(isGameFinished()) return; // ã‚²ãƒ¼ãƒ çµ‚äº†ãªã‚‰è¿½åŠ ä¸å¯

    if(player==='A') scoreA++; else scoreB++;
    updateScores();
    updateServer();
    updatePointStatus();
    stopPlayingTimer();

    // å‹æ•—æ±ºç€æ™‚ã®ã¿ã€ãƒã‚¯ã‚¹ãƒˆã‚²ãƒ¼ãƒ å‰ã«è¡¨ç¤º
    checkGameAndMatchWinner(); 
}

function nextGame(){
    saveState();
    if(scoreA > scoreB){ gamesA++; document.getElementById('gamesA').innerText = gamesA; }
    else if(scoreB > scoreA){ gamesB++; document.getElementById('gamesB').innerText = gamesB; }

    // å±¥æ­´ã«è¿½åŠ 
    const li=document.createElement('li');
    li.innerText=`GAME ${gameNumber}: ${scoreA}-${scoreB}, WINNER ${scoreA>scoreB?'PLAYER A':'PLAYER B'}, FIRST SERVER ${firstServer}, TIME ${document.getElementById('playingTimerDisplay').innerText}`;
    document.getElementById('historyList').appendChild(li);

    // æ¬¡ã‚²ãƒ¼ãƒ æº–å‚™
    playingSeconds = 0;
    stopPlayingTimer();
    gameNumber++;
    scoreA = 0;
    scoreB = 0;
    firstServer = (firstServer==='A')?'B':'A';
    [leftPlayer,rightPlayer] = [rightPlayer,leftPlayer];
    updatePlayerPositions();
    updateScores();
    updateServer();
    updatePointStatus();
}

function removePoint(player){
    saveState();
    if(player==='A' && scoreA>0) scoreA--;
    if(player==='B' && scoreB>0) scoreB--;
    updateScores();
    updateServer();
    updatePointStatus();
    stopPlayingTimer();

    // å‹è€…è¡¨ç¤ºãŒæ®‹ã£ã¦ã„ãŸå ´åˆã¯æ¶ˆã™
    if(gamesA < GAMES_TO_WIN && gamesB < GAMES_TO_WIN){
        document.getElementById("winner").textContent = "";
        enableControls(); // æ“ä½œå¯èƒ½ã«æˆ»ã™
    }
}


function updateScores(){ document.getElementById('scoreA').innerText=scoreA; document.getElementById('scoreB').innerText=scoreB; }
function isGameFinished(){ return ((scoreA>=11||scoreB>=11)&&Math.abs(scoreA-scoreB)>=2); }
function updateServer(){ if(isGameFinished()){ document.getElementById('serveA').innerText=""; document.getElementById('serveB').innerText=""; return; } let total=scoreA+scoreB; if(scoreA>=10 && scoreB>=10){ serveTurn=(total%2===0)?firstServer:(firstServer==='A'?'B':'A'); } else { serveTurn=(Math.floor(total/2)%2===0)?firstServer:(firstServer==='A'?'B':'A'); } document.getElementById('serveA').innerText=(serveTurn==='A')?"ğŸ”´":""; document.getElementById('serveB').innerText=(serveTurn==='B')?"ğŸ”´":""; }
function updatePointStatus(){ let statusA="", statusB=""; if(scoreA>=10 && scoreA>scoreB && !isGameFinished()) statusA="GAME POINT"; if(scoreB>=10 && scoreB>scoreA && !isGameFinished()) statusB="GAME POINT"; if(gamesA===GAMES_TO_WIN-1 && scoreA>=10 && !isGameFinished()) statusA="MATCH POINT"; if(gamesB===GAMES_TO_WIN-1 && scoreB>=10 && !isGameFinished()) statusB="MATCH POINT"; document.getElementById('pointAStatus').innerText=statusA; document.getElementById('pointBStatus').innerText=statusB; }

// ----------------------------
// ã‚«ãƒ¼ãƒ‰ç®¡ç†
function updateCards(player){ let el=(player==='A')?document.getElementById('cardsA'):document.getElementById('cardsB'); el.innerHTML=''; for(let i=0;i<cardCount[player].timeout;i++){ let span=document.createElement('span'); span.className='timeout'; el.appendChild(span); } for(let i=0;i<cardCount[player].yellow;i++){ let span=document.createElement('span'); span.className='yellow'; el.appendChild(span); } for(let i=0;i<cardCount[player].red;i++){ let span=document.createElement('span'); span.className='red'; el.appendChild(span); } }
function card(player,type){ saveState(); if(cardCount[player][type]!==undefined){ cardCount[player][type]++; updateCards(player); } }
function removeCard(player,type){ saveState(); if(cardCount[player][type] && cardCount[player][type]>0){ cardCount[player][type]--; updateCards(player); } }
function timeout(player){ prepareTimer('TIMEOUT'); card(player,'timeout'); }
function setMatchType(){ GAMES_TO_WIN=parseInt(document.getElementById("matchType").value); resetMatch(); }

// ----------------------------
// ãƒ—ãƒ¬ã‚¤ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼
function servePoint(){ stopPlayingTimer(); let lastTime = Date.now(); playingTimerInterval = setInterval(()=>{ const now = Date.now(); playingSeconds += (now-lastTime)/1000; lastTime = now; updatePlayingTimerDisplay(); }, 50); }
function letPoint(){ stopPlayingTimer(); }
function stopPlayingTimer(){ clearInterval(playingTimerInterval); updatePlayingTimerDisplay(); }
function updatePlayingTimerDisplay(){ const minutes=Math.floor(playingSeconds/60); const seconds=(playingSeconds%60).toFixed(1); document.getElementById('playingTimerDisplay').innerText = `${minutes}m${seconds}s`; }

// ----------------------------
// ã‚¿ã‚¤ãƒãƒ¼
function prepareTimer(type){ timerLabel = type; if(type==="WARM UP") timerSeconds=120; else if(type==="WATER BREAK") timerSeconds=60; else if(type==="TIMEOUT") timerSeconds=60; updateTimerDisplay(); showTimerButtons(true); document.getElementById('clearTimerBtn').style.display="inline-block"; clearInterval(timerInterval); if(type==="TIMEOUT"){ timerInterval = setInterval(()=>{ if(timerSeconds>0){ timerSeconds--; updateTimerDisplay(); } else { forceEndTimer(); } },1000); } }
function showTimerButtons(show){ document.getElementById('timerControls').style.display=show?'block':'none'; }
function startTimer(){ clearInterval(timerInterval); timerInterval=setInterval(()=>{ if(timerSeconds>0){ timerSeconds--; updateTimerDisplay(); } else { clearInterval(timerInterval); } },1000); }
function stopTimer(){ clearInterval(timerInterval); }
function resetTimer(){ if(timerLabel==="WARM UP") timerSeconds=120; else timerSeconds=(timerLabel==="WATER BREAK")?60:60; updateTimerDisplay(); }
function forceEndTimer(){ clearInterval(timerInterval); timerSeconds=0; timerLabel=""; document.getElementById('timerDisplay').innerText=""; showTimerButtons(false); document.getElementById('clearTimerBtn').style.display="none"; }
function updateTimerDisplay(){
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    const formatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById('timerDisplay').innerText = `${timerLabel} ${formatted}`;
}


// ----------------------------
// æ¬¡ã‚²ãƒ¼ãƒ 
function nextGame(){
    saveState();
    if(scoreA > scoreB){ gamesA++; document.getElementById('gamesA').innerText = gamesA; }
    else if(scoreB > scoreA){ gamesB++; document.getElementById('gamesB').innerText = gamesB; }

    // å±¥æ­´ã«è¿½åŠ 
    const li=document.createElement('li');
    li.innerText=`GAME ${gameNumber}: ${scoreA}-${scoreB}, WINNER ${scoreA>scoreB?'PLAYER A':'PLAYER B'}`;
    document.getElementById('historyList').appendChild(li);

    // æ¬¡ã‚²ãƒ¼ãƒ æº–å‚™
    gameNumber++;
    scoreA=0; scoreB=0;
    firstServer=(firstServer==='A')?'B':'A';
    [leftPlayer,rightPlayer]=[rightPlayer,leftPlayer];
    updatePlayerPositions();
    updateScores();
    updateServer();
    updatePointStatus();

    // å‹è€…è¡¨ç¤ºãŒæ®‹ã£ã¦ã„ãŸå ´åˆã¯æ¶ˆã™ï¼ˆã¾ã è©¦åˆç¶šè¡Œï¼‰
    document.getElementById("winner").textContent = "";
    enableControls();
}

// ----------------------------
// ãƒªã‚»ãƒƒãƒˆ
function resetMatch(){
  scoreA = 0; scoreB = 0; gamesA = 0; gamesB = 0; gameNumber = 1; 
  cardCount = {A:{yellow:0,red:0,timeout:0},B:{yellow:0,red:0,timeout:0}}; historyStack = []; playingSeconds=0; stopPlayingTimer();
  document.getElementById('gamesA').innerText = 0;
  document.getElementById('gamesB').innerText = 0;
  document.getElementById('scoreA').innerText = 0;
  document.getElementById('scoreB').innerText = 0;
  document.getElementById('historyList').innerHTML = ""; 
  document.getElementById('pointAStatus').innerText = "";
  document.getElementById('pointBStatus').innerText = "";
  document.getElementById('serveA').innerText = "";
  document.getElementById('serveB').innerText = "";
  updateCards('A'); updateCards('B'); forceEndTimer(); 
  document.getElementById('mainScreen').style.display = 'none'; document.getElementById('startScreen').style.display = 'flex';
}

function updatePlayerPositions(){
  const court = document.getElementById('court');
  const playerAEl = document.getElementById('playerA');
  const playerBEl = document.getElementById('playerB');

  // ä¸¦ã³æ›¿ãˆï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  court.appendChild(document.getElementById('player' + leftPlayer));
  court.appendChild(document.getElementById('player' + rightPlayer));

  // ã‚µã‚¤ãƒ‰ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼ˆã“ã“ãŒé‡è¦ï¼‰
  playerAEl.classList.toggle('left',  leftPlayer === 'A');
  playerAEl.classList.toggle('right', leftPlayer !== 'A');
  playerBEl.classList.toggle('left',  leftPlayer === 'B');
  playerBEl.classList.toggle('right', leftPlayer !== 'B');
}


function nextGame(){
  saveState();
if(scoreA>scoreB){
    gamesA++;
    document.getElementById('gamesA').innerText=gamesA;
} else {
    gamesB++;
    document.getElementById('gamesB').innerText=gamesB;
}

// --- å‹è€…åˆ¤å®š ---
if(gamesA === GAMES_TO_WIN){
    declareWinner('A'); // PLAYER A ãŒå‹åˆ©
} else if(gamesB === GAMES_TO_WIN){
    declareWinner('B'); // PLAYER B ãŒå‹åˆ©
}

  
    const li=document.createElement('li');
  li.innerText=`GAME ${gameNumber}: ${scoreA}-${scoreB}, WINNER ${scoreA>scoreB?'PLAYER A':'PLAYER B'}, FIRST SERVER ${firstServer}, TIME ${document.getElementById('playingTimerDisplay').innerText}`;
  document.getElementById('historyList').appendChild(li);

  playingSeconds=0;
  stopPlayingTimer();
  gameNumber++; scoreA=0; scoreB=0;
  firstServer=(firstServer==='A')?'B':'A';
  [leftPlayer,rightPlayer]=[rightPlayer,leftPlayer]; updatePlayerPositions();
  updateScores(); updateServer(); updatePointStatus();
}

function declareWinner(player) {
  const winnerText = `PLAYER ${player} WINS!`;
  document.getElementById("winner").textContent = winnerText;

  // æ“ä½œãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  disableControls();
}
function disableControls() {
    document.querySelectorAll("button").forEach(btn => {
        // ã“ã®ãƒœã‚¿ãƒ³ã ã‘æœ‰åŠ¹
        if (btn.textContent.includes("RESET MATCH") || btn.textContent.includes("UNDO LAST ACTION")) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    });
}
function enableControls() {
    document.querySelectorAll("button").forEach(btn => {
        btn.disabled = false; // å…¨éƒ¨æœ‰åŠ¹åŒ–
    });
}
function undo(){
    if(historyStack.length>0){
        let last=historyStack.pop();
        scoreA=last.scoreA;
        scoreB=last.scoreB;
        gamesA=last.gamesA;
        gamesB=last.gamesB;
        cardCount=last.cardCount;
        playingSeconds=last.playingSeconds;
        updateScores();
        updateCards('A');
        updateCards('B');
        document.getElementById('gamesA').innerText=gamesA;
        document.getElementById('gamesB').innerText=gamesB;
        updatePointStatus();
        updatePlayingTimerDisplay();

        // å‹è€…è¡¨ç¤ºã‚‚æ¶ˆã™
        document.getElementById("winner").textContent = "";

        // æ“ä½œãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        enableControls();
    }
}

document.getElementById("winner").textContent = ""; // å‹è€…è¡¨ç¤ºã‚’æ¶ˆã™
function resetMatch(){
  scoreA = 0; scoreB = 0; gamesA = 0; gamesB = 0; gameNumber = 1; 
  cardCount = {A:{yellow:0,red:0,timeout:0},B:{yellow:0,red:0,timeout:0}}; historyStack = []; playingSeconds=0; stopPlayingTimer();
  document.getElementById('gamesA').innerText = 0;
  document.getElementById('gamesB').innerText = 0;
  document.getElementById('scoreA').innerText = 0;
  document.getElementById('scoreB').innerText = 0;
  document.getElementById('historyList').innerHTML = ""; 
  document.getElementById('pointAStatus').innerText = "";
  document.getElementById('pointBStatus').innerText = "";
  document.getElementById('serveA').innerText = "";
  document.getElementById('serveB').innerText = "";
  updateCards('A'); updateCards('B'); forceEndTimer(); 

  document.getElementById('winner').textContent = ""; // å‹è€…è¡¨ç¤ºã‚’æ¶ˆã™

  document.getElementById('mainScreen').style.display = 'none'; 
  document.getElementById('startScreen').style.display = 'flex';
  
  // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
  document.querySelectorAll("button").forEach(btn => btn.disabled = false);
}
function declareWinner(player, currentGameWinner) {
    // ç¾åœ¨ã‚²ãƒ¼ãƒ ã®å‹è€…ã‚’åŠ ç®—ã—ãŸæœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
    const finalGamesA = gamesA + (currentGameWinner === 'A' ? 1 : 0);
    const finalGamesB = gamesB + (currentGameWinner === 'B' ? 1 : 0);

    // å‹è€…è¡¨ç¤º
    document.getElementById("winner").textContent =
        `GAME AND MATCH TO PLAYER ${player} (${finalGamesA}-${finalGamesB})`;

    // ãƒœã‚¿ãƒ³åˆ¶å¾¡ï¼ˆRESET ã¨ UNDO ä»¥å¤–ç„¡åŠ¹ï¼‰
    disableControls();
}
function declareMatchWinner(){
    const winner = (gamesA === GAMES_TO_WIN) ? "PLAYER A" : "PLAYER B";
    document.getElementById("winner").textContent = 
        `Game And Match To ${winner} ${gamesA}-${gamesB}`;
}


function checkGameAndMatchWinner() {
    // ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®š
    if (!isGameFinished()) return;

    let gameWinner = (scoreA > scoreB) ? 'A' : 'B';
    let finalA = gamesA + (gameWinner === 'A' ? 1 : 0);
    let finalB = gamesB + (gameWinner === 'B' ? 1 : 0);

    // ãƒãƒƒãƒçµ‚äº†åˆ¤å®š
    if (finalA === GAMES_TO_WIN || finalB === GAMES_TO_WIN) {
        const winner = (finalA === GAMES_TO_WIN) ? "A" : "B";
        let winnerScore, loserScore;

        if (winner === "A") {
            winnerScore = finalA;
            loserScore = finalB;
        } else {
            winnerScore = finalB;
            loserScore = finalA;
        }

        // ğŸŸ¦ ãƒãƒƒãƒçµ‚äº†æ™‚ã®ã¿é’è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('gamesA').innerText = finalA;
        document.getElementById('gamesB').innerText = finalB;

        // å‹è€…è¡¨ç¤º
        document.getElementById("winner").textContent =
            `GAME AND MATCH TO PLAYER ${winner} (${winnerScore}-${loserScore})`;

        disableControls();
    }
}

function enableControls() {
    document.querySelectorAll("button").forEach(btn => btn.disabled=false);
}
function resetMatch(){
    if (!confirm("Are you sure you want to reset the match?")) return;

    scoreA = 0; scoreB = 0; gamesA = 0; gamesB = 0; gameNumber = 1; 
    cardCount = {A:{yellow:0,red:0,timeout:0},B:{yellow:0,red:0,timeout:0}};
    historyStack = [];
    playingSeconds = 0;
    stopPlayingTimer();

    document.getElementById('gamesA').innerText = 0;
    document.getElementById('gamesB').innerText = 0;
    document.getElementById('scoreA').innerText = 0;
    document.getElementById('scoreB').innerText = 0;
    document.getElementById('historyList').innerHTML = ""; 
    document.getElementById('pointAStatus').innerText = "";
    document.getElementById('pointBStatus').innerText = "";
    document.getElementById('serveA').innerText = "";
    document.getElementById('serveB').innerText = "";
    document.getElementById('winner').textContent = "";

    updateCards('A'); updateCards('B');
    forceEndTimer(); 

    document.getElementById('mainScreen').style.display = 'none'; 
    document.getElementById('startScreen').style.display = 'flex';

    

    enableControls();
}



function setMatchType(){
  const selected = parseInt(document.getElementById("matchType").value);
  // é¸æŠå€¤ã‚’ã€Œå‹åˆ©ã«å¿…è¦ãªã‚²ãƒ¼ãƒ æ•°ã€ã«å¤‰æ›
  if (selected === 2) GAMES_TO_WIN = 2;  // Best of 3
  else if (selected === 3) GAMES_TO_WIN = 3; // Best of 5
  else if (selected === 4) GAMES_TO_WIN = 4; // Best of 7
  resetMatch();
}

function updateTimerDisplay(){
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    const formatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById('timerDisplay').innerText = `${timerLabel} ${formatted}`;
}



/* ===========================
   ğŸš€ EXPEDITE RULE (ä¿ƒé€²ãƒ«ãƒ¼ãƒ«)
   =========================== */

/* ===========================
   ğŸš€ EXPEDITE RULEï¼ˆä¿ƒé€²ãƒ«ãƒ¼ãƒ«ï¼‰
   =========================== */

let expediteMode = false;
let expediteFirstServer = null;
let lastTotalPoints = 0;  // â†â˜… ã“ã“ãŒæœ€ã‚‚é‡è¦

// --- ä¿ƒé€²ãƒ«ãƒ¼ãƒ«é–‹å§‹ç”»é¢ ---
function activateExpediteRule() {
    if (expediteMode) {
        alert("Expedite Rule is already active.");
        return;
    }

    const screen = document.createElement("div");
    screen.id = "expediteSelectScreen";
    screen.style = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        z-index: 99999; color: white;
    `;
    screen.innerHTML = `
        <h2 style="font-size:2em; margin-bottom:1em;">Expedite Rule</h2>
        <p>Select who serves first:</p>
        <div style="margin-top:1em;">
            <button id="expServeA" style="font-size:1.4em; margin:0.5em;">PLAYER A</button>
            <button id="expServeB" style="font-size:1.4em; margin:0.5em;">PLAYER B</button>
        </div>
    `;
    document.body.appendChild(screen);

    document.getElementById("expServeA").onclick = () => startExpedite("A");
    document.getElementById("expServeB").onclick = () => startExpedite("B");
}

// --- ä¿ƒé€²ãƒ«ãƒ¼ãƒ«é–‹å§‹å‡¦ç† ---
function startExpedite(server) {
    expediteMode = true;
    expediteFirstServer = server;
    serveTurn = server;           // â†â˜… å¿…ãšé¸ã‚“ã äººãŒã‚µãƒ¼ãƒ–
    lastTotalPoints = scoreA + scoreB;  // â†â˜… ç›´å¾Œã« updateServer ã§äº¤ä»£ã•ã›ãªã„ãŸã‚ã®ãƒ­ãƒƒã‚¯

    document.getElementById("expediteSelectScreen").remove();

    // ãƒãƒŠãƒ¼è¡¨ç¤º
    const banner = document.createElement("div");
    banner.id = "expediteBanner";
    banner.textContent = "EXPEDITE RULE IN EFFECT (1-serve alternation)";
    banner.style = `
        position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
        background: #ff3333; color: white;
        padding: 0.5em 1.2em; border-radius: 10px;
        z-index: 9999; font-weight: bold;
    `;
    document.body.appendChild(banner);

    updateServer(); // â†â˜… å®Œå…¨ã«ä¿®æ­£ã•ã‚ŒãŸ updateServer ã§ç¢ºå®šè¡¨ç¤º
}

/* ---------------------------------
     ğŸš¨ ã“ã“ãŒä»Šå›ã®ä¿®æ­£ã®æ ¸å¿ƒéƒ¨åˆ†
-----------------------------------*/
function updateServer() {
    let total = scoreA + scoreB;

    if (expediteMode) {
        // â˜… ä¿ƒé€²ãƒ«ãƒ¼ãƒ«ã«å…¥ã£ãŸç›´å¾Œã¯ total ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã®ã§äº¤ä»£ã•ã›ãªã„
        if (total !== lastTotalPoints) {
            // 1 ç‚¹å…¥ã£ãŸã‚‰äº¤ä»£
            serveTurn = (serveTurn === "A") ? "B" : "A";
            lastTotalPoints = total;  // ç‚¹æ•°ã‚’æ›´æ–°
        }

        // è¡¨ç¤ºæ›´æ–°
        document.getElementById("serveA").innerText = (serveTurn === "A") ? "ğŸ”´" : "";
        document.getElementById("serveB").innerText = (serveTurn === "B") ? "ğŸ”´" : "";
        return; // é€šå¸¸ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨åœæ­¢
    }

    /* ===== ã“ã“ã‹ã‚‰é€šå¸¸ã‚µãƒ¼ãƒ–ãƒ­ã‚¸ãƒƒã‚¯ ===== */

    if (isGameFinished()) {
        document.getElementById("serveA").innerText = "";
        document.getElementById("serveB").innerText = "";
        return;
    }

    if (scoreA >= 10 && scoreB >= 10) {
        serveTurn = (total % 2 === 0) ? firstServer : (firstServer === "A" ? "B" : "A");
    } else {
        serveTurn = (Math.floor(total / 2) % 2 === 0) ? firstServer : (firstServer === "A" ? "B" : "A");
    }

    document.getElementById("serveA").innerText = (serveTurn === "A") ? "ğŸ”´" : "";
    document.getElementById("serveB").innerText = (serveTurn === "B") ? "ğŸ”´" : "";
}

/* --- åœæ­¢å‡¦ç† --- */
function deactivateExpediteRule() {
    expediteMode = false;
    expediteFirstServer = null;
    lastTotalPoints = 0;

    if (document.getElementById("expediteBanner")) {
        document.getElementById("expediteBanner").remove();
    }

    updateServer();
}

// â˜… ä¿ƒé€²ãƒ«ãƒ¼ãƒ«è¾¼ã¿ã® resetMatch å®Œå…¨ç‰ˆ
const originalResetMatch = resetMatch;   // â† æ—¢å­˜ resetMatch ã‚’ä¿å­˜ã—ã¦ãŠã

resetMatch = function(silent = false) {

    // --- ä¿ƒé€²ãƒ«ãƒ¼ãƒ«ã‚’å®Œå…¨è§£é™¤ ---
    expediteMode = false;
    expediteFirstServer = null;
    lastTotalPoints = 0;

    // ãƒãƒŠãƒ¼å‰Šé™¤
    const banner = document.getElementById("expediteBanner");
    if (banner) banner.remove();

    // ãƒœã‚¿ãƒ³åˆæœŸåŒ–
    const startBtn = document.getElementById("startExpediteBtn");
    const stopBtn = document.getElementById("stopExpediteBtn");
    if (startBtn && stopBtn) {
        startBtn.disabled = false;
        startBtn.style.opacity = "1";
        stopBtn.disabled = true;
        stopBtn.style.opacity = "0.6";
    }

    // --- æœ¬æ¥ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ ---
    originalResetMatch(silent);

    // ã‚µãƒ¼ãƒ–è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
    document.getElementById("serveA").innerText = "";
    document.getElementById("serveB").innerText = "";
};





</script>

</body>
</html>ã€€ã€€ã€€ã€€